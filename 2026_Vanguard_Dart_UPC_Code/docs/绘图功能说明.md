# 绘图功能使用说明

## 功能概述

上位机软件现在支持实时多曲线绘图功能，可以同时显示多个数据通道的波形。

## 数据协议格式

发送到上位机的绘图数据格式为：

```
AT+DRAW+<数据名称>+<具体数据内容>
```

### 示例

```
AT+DRAW+Temperature+25.5
AT+DRAW+Voltage+3.3
AT+DRAW+Humidity+65.2
AT+DRAW+Current+1.25
```

## 功能特点

1. **多曲线支持**: 自动识别不同的数据名称，为每个数据通道创建独立的曲线
2. **颜色区分**: 每条曲线使用不同的颜色显示，便于区分
3. **自动图例**: 显示曲线名称和对应的颜色
4. **数据缓存**: 每条曲线最多缓存 1000 个数据点，自动清理旧数据
5. **实时更新**: 接收到数据后实时更新显示
6. **数据导出**: 支持将所有曲线数据导出为 CSV 格式

## 使用方法

### 1. 启动主程序

```bash
cd /home/bale/QT/LinuxUPC/SourceCode
python main_app.py
```

### 2. 连接串口

- 输入串口设备名（例如：`/dev/ttyUSB0`）
- 选择波特率（默认：115200）
- 点击"连接"按钮

### 3. 查看波形

- 切换到"波形显示"标签页
- 当设备发送符合格式的数据时，波形会自动显示

### 4. 操作按钮

- **清空波形**: 清除所有已显示的数据和曲线
- **导出波形数据**: 将当前所有曲线的数据导出为 CSV 文件

## 测试方法

### 方法一：使用测试脚本（推荐）

项目提供了测试脚本用于模拟数据发送：

```bash
# 使用 socat 创建虚拟串口对
socat -d -d pty,raw,echo=0 pty,raw,echo=0

# 假设输出为：
# N PTY is /dev/pts/3
# N PTY is /dev/pts/4

# 在主程序中连接 /dev/pts/3
# 在新终端运行测试脚本：
python tests/test_plot_simulator.py /dev/pts/4

# 或指定参数：
python tests/test_plot_simulator.py /dev/pts/4 -b 115200 -d 60
```

测试脚本会模拟发送 5 种不同的数据：
- Temperature (正弦波)
- Voltage (余弦波)
- Humidity (随机波动)
- Current (锯齿波)
- Speed (阶跃函数)

### 方法二：使用串口调试工具

使用任何串口调试工具（如 minicom, screen, picocom）手动发送数据：

```bash
echo "AT+DRAW+Temperature+25.5" > /dev/ttyUSB0
echo "AT+DRAW+Voltage+3.3" > /dev/ttyUSB0
```

### 方法三：使用 Arduino 或其他嵌入式设备

在你的嵌入式设备代码中添加：

```c
// Arduino 示例
Serial.println("AT+DRAW+Temperature+" + String(temperature));
Serial.println("AT+DRAW+Voltage+" + String(voltage));
```

```python
# MicroPython 示例
uart.write("AT+DRAW+Temperature+{}\n".format(temperature))
uart.write("AT+DRAW+Voltage+{}\n".format(voltage))
```

## 导出的数据格式

导出的 CSV 文件格式：

```csv
Sample_Index,Current,Humidity,Speed,Temperature,Voltage
0,0.0,52.34,100.0,25.0,3.3
1,0.1,48.56,100.0,25.99,3.29
2,0.2,55.67,100.0,26.98,3.27
...
```

- 第一列为采样索引
- 后续列为各个数据通道
- 通道按字母顺序排列

## 注意事项

1. **数据格式**: 必须严格按照 `AT+DRAW+<名称>+<数值>` 格式，使用 `+` 分隔
2. **数值类型**: 数据内容必须是有效的数字（整数或浮点数）
3. **编码**: 建议使用 UTF-8 编码
4. **换行符**: 每条数据以换行符结束（`\n`）
5. **性能**: 建议发送频率不超过 20Hz，以保证界面流畅
6. **内存**: 每条曲线最多保存 1000 个数据点，超出后自动删除最旧的数据

## 颜色方案

系统为前 8 个数据通道预设了不同颜色：
1. 粉红色 (255, 105, 180)
2. 青绿色 (64, 224, 208)
3. 金色 (255, 215, 0)
4. 紫色 (147, 112, 219)
5. 珊瑚色 (255, 127, 80)
6. 浅绿色 (144, 238, 144)
7. 浅粉色 (255, 182, 193)
8. 浅蓝色 (173, 216, 230)

超过 8 个通道后颜色会循环使用。

## 故障排查

### 问题：曲线不显示

- 检查数据格式是否正确（必须是 `AT+DRAW+名称+数值`）
- 检查串口是否正确连接
- 查看日志窗口是否有数据接收
- 确认切换到了"波形显示"标签页

### 问题：曲线显示不完整

- 检查数值是否为有效数字
- 查看日志窗口是否有错误信息
- 尝试使用测试脚本验证功能

### 问题：导出数据失败

- 检查是否有写入权限
- 确保选择了有效的保存路径
- 确认有数据可以导出

## 技术细节

- **绘图库**: pyqtgraph（高性能实时绘图）
- **数据结构**: 使用 defaultdict 存储多通道数据
- **线程模型**: 使用 QThread 处理串口通信，避免界面冻结
- **信号槽**: 使用 pyqtSignal 在线程间传递数据

## 版本信息

- 版本: 3.1 (波形显示版)
- 更新日期: 2025-11-18
- 作者: BaleDeng
